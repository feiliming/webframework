<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="edge" />
<#include "/html/include.html" />
<!-- 增加按钮的样式 -->
<style type="text/css">
	.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
</style>
</head>
<body>

<div class="easyui-layout" data-options="fit:true,border:false">
	<div id="west" data-options="region:'west',border:false,split:true" title="组织机构" style="width:250px;overflow: auto;">
		<ul id="orgTree" class="ztree"></ul>
	</div>
	<div id="center" data-options="region:'center',border:false,title:'用户列表'">
		<div id="userToolbar">
			<a onclick="addUser();" href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add'">添加</a>
		</div>
		<table id="userDataGrid" data-options="fit:true,border:false"></table>
	</div>
</div>

<div id="userAddDialog"></div>
<div id="userEditDialog"></div>


<SCRIPT type="text/javascript">
	var setting = {
		view: {
			addHoverDom: addHoverDom,
			removeHoverDom: removeHoverDom,
			selectedMulti: false
		},
		data: {
			simpleData: {
				enable: true
			}
		},
		callback: {
			onClick: onClick
		}
	};
	
	function onClick(event, treeId, treeNode){
		$.ajax({
			type : "GET",
			url : '${contextPath}' + '/user/getUsers',
			async : false,
			success : function(data) {
				$.fn.zTree.init($("#orgTree"), setting, data);
			}
		});
	}
	
	function showRemoveBtn(treeId, treeNode) {
		return false;
	}
	
	function showRenameBtn(treeId, treeNode) {
		return false;
	}

	function addHoverDom(treeId, treeNode) {
		var sObj = $("#" + treeNode.tId + "_span");
		if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
		var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
			+ "' title='添加用户' onfocus='this.blur();'></span>";
		sObj.after(addStr);
		var btn = $("#addBtn_"+treeNode.tId);
		if (btn) btn.bind("click", function(){
			addUser(treeNode.id);
		});
	};
	
	function removeHoverDom(treeId, treeNode) {
		$("#addBtn_"+treeNode.tId).unbind().remove();
	};
	
	$(document).ready(function(){
		$.ajax({
			type : "GET",
			url : '${contextPath}' + '/org/getOrgs',
			async : false,
			success : function(data) {
				$.fn.zTree.init($("#orgTree"), setting, data);
			}
		});
	});
	
	var userAddDialog;
	function addUser(orgId){
		userAddDialog = $("#userAddDialog").dialog({
		    title: '添加机构',
		    width: 500,
		    height: 350,
		    cache: false,
		    iconCls: 'icon-add',
		    href: '${contextPath}/user/addPage?orgId=' + orgId,
		    modal: true,
		    onLoad: function(){
		    	$('#userAddName').textbox('textbox').focus();
		    },
		    buttons: [{
		    	text: '保存',
		    	iconCls:'icon-save',
		    	handler:function(){
					addUserSubmit();
		    	}
		    },{
		    	text: '取消',
		    	iconCls:'icon-cancel',
		    	handler:function(){
		    		userAddDialog.dialog('close');
		    	}
		    }]
		}); 
	}
	
	var userEditDialog;
	function editUser(id){
		if (id == undefined) {
			shownok("请选择一条数据进行编辑!");
			return;
		}
		userEditDialog = $("#userEditDialog").dialog({
		    title: '编辑机构',
		    width: 500,
		    height: 350,
		    cache: false,
		    iconCls: 'icon-add',
		    href: '${contextPath}/user/editPage?id=' + id,
		    modal: true,
		    onLoad: function(){
		    	$('#userEditName').textbox('textbox').focus();
		    },
		    buttons: [{
		    	text: '保存',
		    	iconCls:'icon-save',
		    	handler:function(){
					editUserSubmit();
		    	}
		    },{
		    	text: '取消',
		    	iconCls:'icon-cancel',
		    	handler:function(){
		    		userEditDialog.dialog('close');
		    	}
		    }]
		}); 
	}
	
	$(function(){
		var userDataGrid;
		$(function() {
			userDataGrid = $('#userDataGrid').datagrid({
				url : '${contextPath}' + '/user/getUsers',
				striped : true,
				rownumbers : true,
				pagination : true,
				singleSelect : true,
				idField : 'id',
				//sortName : 'sequence',
				//sortOrder : 'asc',
				pageSize : 20,
				pageList : [ 10, 20, 30, 40, 50, 100],
				nowrap: false,
				columns : [ [ {
					///width : '100',
					title : 'id',
					field : 'id'
				}, {
					width : '100',
					title : '登录名称',
					field : 'login_name'
				} , {
					width : '80',
					title : '创建时间',
					field : 'create_time'
				} , {
					field : 'action',
					title : '操作',
					//width : 120,
					formatter : function(value, row, index) {
						var str = '&nbsp;';
						str += $.formatString('<a href="javascript:void(0)" onclick="grantFun(\'{0}\');" >设置角色</a>', row.id);
						str += '&nbsp;|&nbsp;';
						str += $.formatString('<a href="javascript:void(0)" onclick="editUser(\'{0}\');" >编辑</a>', row.id);
						str += '&nbsp;|&nbsp;';
						str += $.formatString('<a href="javascript:void(0)" onclick="deleteUser(\'{0}\');" >删除</a>', row.id);
						str += '&nbsp;';
						return str;
					}
				} ] ],
				toolbar : '#userToolbar'
			});
		});
	})
</SCRIPT>
</body>
</html>